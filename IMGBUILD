#!/usr/bin/bash /usr/bin/makepkg
# Maintainer: Moses Narrow <moe_narrow@use.startmail.com>
pkgname=skybian-img
pkgdesc="Skybian image creator"
pkgver='autogenerated'
pkgrel=1
arch=( 'any')
_img="Armbian_21.08.1_Orangepiprime_buster_current_5.10.60.img"
_imglink="https://mirrors.netix.net/armbian/dl/orangepiprime/archive/Armbian_21.08.1_Orangepiprime_buster_current_5.10.60.img.xz"
_imgfinal="skybian-${pkgver}.img"
_skywiredeb="skywire-bin-0.5.1-8-arm64.deb"
url="http://github.com/skycoin/skybian"
#_gz="Armbian_21.08.1_Orangepiprime_buster_current_5.10.60.img.xz"
#_gz=${_gz//"--"/"-"}
makedepends=('gnome-disks' 'qemu-arm-static-bin')
depends=()
source=("${_imglink}"
"${imglink}.sha"
"https://deb.magnetosphere.net/archive/${_skywiredeb}"
"https://deb.magnetosphere.net/KEY.asc"
)
#noextract=("${_gz}")
sha256sums=('SKIP'
'SKIP')

pkgver() {
echo $(date +%Y%m%d)
}

build() {
  cp -b ${_img} ${_imgfinal}
  gnome-disk-image-mounter -w ${_imgfinal}
  mkdir -p ${srcdir}/mnt
  sudo mount /dev/loop0p1 ${srcdir}/mnt
  sudo cp -b ${srcdir}/${_skywiredeb} ${srcdir}/mnt/var/cache/apt/archive/${_skywiredeb}
  sudo cp -b ${srcdir}/KEY.asc ${srcdir}/mnt/root/KEY.asc
  sudo cp "$(command -v qemu-aarch64-static)" "${srcdir}/mnt/usr/bin/"
  ###CUSTOM CONFIGURATION GOES HERE###
  ##Setting the apt repository configuration in /etc/sources.list
  sudo arch-chroot ${srcdir}/mnt "add-apt-repository 'deb http://deb.magnetosphere.net sid main'"
  sudo arch-chroot ${srcdir}/mnt "cat /root/KEY.asc | apt-key add -"
  ##install the package with dpkg
  sudo arch-chroot ${srcdir}/mnt "dpkg -i /mnt/var/cache/apt/archive/${_skywiredeb}"
  sudo arch-chroot ${srcdir}/mnt "rm /opt/skywire/skywire.json"
  #activate systemd service for creating the config on first boot
  #sudo arch-chroot ${srcdir}/mnt "systemctl enable --now skywire-bootconfig"
  ###END CUSTOM CONFIGURATION###
	sudo umount ${srcdir}/mnt
	sudo losetup -d /dev/loop0
  mv ${_imgfinal} ../${_imgfinal}
}

package() {
  cd ..
  echo "created image(s):"
  ls $_imgfinal
  rm -rf ${pkgdir}
exit
}
